## lab 11-2

> 1811464 éƒ‘ä½¶ ä¿¡æ¯å®‰å…¨å•å­¦ä½

#### é—®é¢˜1: åˆ†ææ¶æ„`DLL`æ–‡ä»¶çš„å¯¼å‡ºæ•°æ®ä¿¡æ¯

ä½¿ç”¨`IDA Pro`æŸ¥çœ‹`Lab11-02.dll`çš„å¯¼å‡ºå‡½æ•°è¡¨,å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯

![](../IMG/LAB11-2-1.png)

ç”±æ­¤å¯çŸ¥,è¯¥`DLL`æ–‡ä»¶å¯¼å‡ºäº†å¯¼å‡ºå‡½æ•°`installer`



#### é—®é¢˜2: ä½¿ç”¨æŒ‡å®šç¨‹åºè¿è¡Œåº“æ–‡ä»¶çš„ç»“æœ

> æŒ‡å®šç¨‹åº:`rundll32.exe`

ä¸ºåˆ†æä½¿ç”¨`rundll32.exe`è¿è¡Œ`Lab11-02.dll`çš„ç»“æœ,ä½¿ç”¨`Procmon`åˆ†æç³»ç»Ÿè·å¾—è®°å½•.

æ‰“å¼€ç¨‹åºç›‘è§†å™¨`Procmon`,ç‚¹å‡»`Filter`é€‰æ‹©ç­›é€‰æ¡ä»¶ä¸º`Process Name = rundll32.exe`å’Œ`Operation = WriteFile`,ç‚¹å‡»å…³é—­èœå•æ çš„å…¶ä»–è®°å½•ç±»åˆ«,ä»…é€‰æ‹©é€‰é¡¹`Show File System Activity`è®°å½•æ–‡ä»¶ç³»ç»Ÿæ´»åŠ¨è®°å½•.ç‚¹å‡»`Clear`åˆ é™¤å…ˆå‰çš„è®°å½•.

ä½¿ç”¨åœ¨`cmd`ä¸­ä½¿ç”¨æŒ‡ä»¤`rundll32.exe Lab11-02.dll installer`è¿è¡Œå®‰è£…æ¶æ„ä»£ç ,å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯

![](../IMG/LAB11-2-2.png)

ç”±ä¸Šå¯è§,è¯¥ç¨‹åºåˆ›å»ºå¹¶å†™å…¥äº†æ–‡ä»¶`spoolvxx32.dll`.

ä¸ºè·å¾—æ›´è¯¦ç»†çš„ä¿¡æ¯,ä½¿ç”¨`IDA Pro`åˆ†æå¯¼å‡ºå‡½æ•°`installer`å’Œä¸»å‡½æ•°`DLLMain`.

å¯¼å‡ºå‡½æ•°`installer`æµç¨‹å›¾å¦‚ä¸‹

![](../IMG/LAB11-2-3.png)

ç»åˆ†æ,å…¶ä¸»è¦è¿è¡Œæµç¨‹å¦‚ä¸‹

- æ‰“å¼€æ³¨å†Œè¡¨é”®`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows`
- åˆ›å»ºæ³¨å†Œè¡¨é¡¹`AppInit_DLLs`,å€¼ä¸º`spoolvxx.dll`

- å¾—åˆ°`system32`æ–‡ä»¶å¤¹è·¯å¾„,å’Œå­—ç¬¦ä¸²`spoolvxx.dll`æ‹¼æ¥
- ä½¿ç”¨å¾—åˆ°çš„è·¯å¾„å°†æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°`spoolvxx32.dll`

ä¸»å‡½æ•°`DLLMain`æµç¨‹å›¾å¦‚ä¸‹

![](../IMG/LAB11-2-4.png)

ç»è¿‡åˆ†æ,å…¶ä¸»è¦è¿è¡Œæµç¨‹å¦‚ä¸‹

- è°ƒç”¨å‡½æ•°`GetModuleFile`å¾—åˆ°å½“å‰æ–‡ä»¶è·¯å¾„
- è°ƒç”¨å­è¿‡ç¨‹`sub_1000105B`å¾—åˆ°`System32`æ–‡ä»¶å¤¹è·¯å¾„,ä¸å­—ç¬¦ä¸²`Lab11-02.ini`æ‹¼æ¥
- è°ƒç”¨å‡½æ•°`CreateFile`æ‰“å¼€æ–‡ä»¶`C:\Windows\System32\Lab11-02.ini`
- è°ƒç”¨å‡½æ•°`ReadFile`è¯»è¯¥æ–‡ä»¶
- è°ƒç”¨å­è¿‡ç¨‹`sub_100010B3`,==è¯¥å­è¿‡ç¨‹é—®é¢˜8ä¸­åˆ†æ==
- è°ƒç”¨å­è¿‡ç¨‹`sub_100014B6`,==è¯¥å­è¿‡ç¨‹é—®é¢˜5ä¸­åˆ†æ==

ç»¼ä¸Š,å¯çŸ¥è¿è¡Œä»£ç åä¼šå‘ç”Ÿ

- å¯¼å‡ºå‡½æ•°`installer`å¤åˆ¶å½“å‰æ–‡ä»¶åˆ°`C:\Windows\System32\spoolvxx32.dll`,å¹¶ä¿®æ”¹æ³¨å†Œè¡¨é”®å¢åŠ `AppInit_DLLs`é¡¹ä»¥æ°¸ä¹…å®‰è£…è¿™ä¸ªæ¶æ„ä»£ç .
- ä¸»å‡½æ•°`DLLMain`æ‰“å¼€æ–‡ä»¶`C:\Windows\System32\Lab11-02.ini`,ä½†æ˜¯æ–‡ä»¶ä¸åœ¨è¯¥ç›®å½•ä¸‹æ‰€ä»¥æ‰“å¼€å¤±è´¥

#### é—®é¢˜3: æŒ‡å®šæ–‡ä»¶çš„å®‰è£…è·¯å¾„

> æŒ‡å®šæ–‡ä»¶:`Lab11-02.ini`

æ ¹æ®`é—®é¢˜2`çš„åˆ†æ,å¯çŸ¥é“è°ƒç”¨`CreateFile`æ˜¯çš„è·¯å¾„æ˜¯`C:\Windows\System32\Lab11-02.ini`,å› æ­¤éœ€è¦å°†æ–‡ä»¶`Lab11-02.ini`æ”¾åœ¨è·¯å¾„`C:\Windows\System32\`.



#### é—®é¢˜4: ç¨‹åºé©»ç•™çš„æ–¹å¼

æ ¹æ®`é—®é¢˜2`çš„åˆ†æ,å¯¼å‡ºå‡½æ•°`installer`æœ‰å¦‚ä¸‹åŠŸèƒ½

- æ‰“å¼€æ³¨å†Œè¡¨é”®`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows`
- åˆ›å»ºæ³¨å†Œè¡¨é¡¹`AppInit_DLLs`,å€¼ä¸º`spoolvxx.dll`

æŸ¥è¯¢`AppInit_DLLs`çš„é”®å€¼çš„åŠŸèƒ½,å¯çŸ¥è¯¥é”®å€¼æŒ‡å‘çš„åº“æ–‡ä»¶ä¼šè¢«åŠ è½½`user32.dll`çš„è¿›ç¨‹è£…è½½.

æ‰€ä»¥ç¨‹åºæ˜¯é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨,ä½¿å¾—æ¶æ„ä»£ç è¢«æ‰€æœ‰åŠ è½½`user32.dll`çš„è¿›ç¨‹è£…è½½,å®ç°é©»ç•™.



#### é—®é¢˜5 :ç¨‹åºä½¿ç”¨çš„ç”¨æˆ·æ€`Rootkit`æŠ€æœ¯

ä¸ºç ”ç©¶ç¨‹åºä½¿ç”¨çš„`Rootkit`æŠ€æœ¯,éœ€è¦åˆ†æä¸»å‡½æ•°`DLLMain`çš„å­è¿‡ç¨‹`sub_100014B6`.

å­è¿‡ç¨‹`sub_100014B6`æµç¨‹å›¾å¦‚ä¸‹

![](../IMG/LAB11-2-6.png)

ç»è¿‡åˆ†æ,å…¶ä¸»è¦è¿è¡Œæµç¨‹å¦‚ä¸‹

- è°ƒç”¨å­è¿‡ç¨‹`sub_10001075`å¾—åˆ°æŒ‡å®šå¥æŸ„çš„ç»å¯¹è·¯å¾„
  - å­è¿‡ç¨‹è°ƒç”¨å‡½æ•°`GetModuleFileName`
- è°ƒç”¨å­è¿‡ç¨‹`sub_10001104`é€šè¿‡å­—ç¬¦ä¸²æ“ä½œå¾—åˆ°æŒ‡å®šè·¯å¾„çš„ç¨‹åºå
- æ£€æŸ¥ç¨‹åºåæ˜¯å¦ä¸º`THEBAT.EXE`æˆ–`OUTLOOK.EXE`æˆ–`MSIMN.EXE`
- è°ƒç”¨å­è¿›ç¨‹`sub_100013BD`æŸ¥æ‰¾å½“å‰è¿›ç¨‹`ID`,ç„¶åæŒ‚èµ·å…¶ä»–è¿›ç¨‹
- è°ƒç”¨å­è¿‡ç¨‹`sub_100012A3`,==è¯¥å­è¿‡ç¨‹éšååˆ†æ==
- è°ƒç”¨å­è¿‡ç¨‹`sub_100013BD`æŸ¥æ‰¾å½“å‰è¿›ç¨‹`ID`,ç„¶åå”¤é†’å…¶ä»–è¿›ç¨‹

ä¸Šè¿°å­è¿‡ç¨‹è°ƒç”¨çš„å­è¿‡ç¨‹`sub_100012A3`çš„æµç¨‹å›¾å¦‚ä¸‹

![](../IMG/LAB11-2-7.png)

ç»è¿‡åˆ†æ,å…¶ä¸»è¦è¿è¡Œæµç¨‹å¦‚ä¸‹

- è°ƒç”¨å‡½æ•°`GetModuleHandle`ã€`LoadLibrary`åŠ è½½åº“æ–‡ä»¶`wsock32.dll`

- è°ƒç”¨å‡½æ•°`GetProcAddress`æ‰¾åˆ°`socket`çš„`send`å‡½æ•°çš„åœ°å€

- è°ƒç”¨å­è¿‡ç¨‹`sub_10001203`

  - è°ƒç”¨å‡½æ•°`VirtualProtect`å–æ¶ˆ`send`å‡½æ•°ä»£ç åŒºåŸŸå†™ä¿æŠ¤

  - ä¿®æ”¹åœ¨`send`å‡½æ•°ä»£ç åŒºåŸŸçš„ä»£ç ,è®¾ç½®æŒ‚é’©,ä½¿`send`å‡½æ•°æ‰§è¡Œå‰å…ˆè·³è½¬è°ƒç”¨æ¶æ„ä»£ç å†è·³è½¬åˆ°åŸä½ç½®ç»§ç»­æ‰§è¡Œ
  - è°ƒç”¨å‡½æ•°`VirtualProtect`æ¢å¤å†™ä¿æŠ¤

ç»¼ä¸Š,ç¨‹åºä½¿ç”¨çš„ç”¨æˆ·æ€`Rootkit`æŠ€æœ¯æ˜¯æŒ‚é’©å‡½æ•°æŠ€æœ¯

#### é—®é¢˜6: æŒ‚é’©å‡½æ•°çš„è¡Œä¸º

å› ä¸ºè¯¥ç¨‹åºä½¿ç”¨åœ°å€å­—ç¬¦ä¸²(==è¯¦è§é—®é¢˜8åˆ†æ==),ä¸”æ ¹æ®`é—®é¢˜5`çš„åˆ†æå­è¿‡ç¨‹`sub_100014B6`ä¼šåˆ¤æ–­å½“å‰ç¨‹åºæ˜¯å¦ä¸ºé‚®ä»¶ç¨‹åº`thebat`æˆ–`outlook`æˆ–`msimn`,æ‰€ä»¥å¯ä»¥æ¨æ–­è¯¥ç¨‹åºçš„æŒ‚é’©å‡½æ•°çš„åŠŸèƒ½åº”è¯¥ä¸é‚®ä»¶æœ‰å…³.

æŸ¥çœ‹`Lab11-02.dll`çš„å­—ç¬¦ä¸²è§†å›¾,å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯

![](../IMG/LAB11-2-8.png)

å¯ä»¥å‘ç°`RCPT TO:`ç­‰å­—ç¬¦ä¸².ç»è¿‡æŸ¥é˜…èµ„æ–™,å¯ä»¥å‘ç°`RCPT TO`æ˜¯`SMTP`é‚®ä»¶åè®®çš„å‘½ä»¤,ç”¨äºæŒ‡å®šæ”¶ä»¶äºº.å¯ä»¥ä»¥æ­¤æ¨æµ‹,è¯¥ç¨‹åºä½¿ç”¨æŒ‚é’©ç¨‹åºä¿®æ”¹é‚®ä»¶çš„æ”¶ä»¶äººä¿¡æ¯ä»¥å®ç°æ¶æ„ä»£ç çš„ç›®çš„.

æŸ¥çœ‹è¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨ä½ç½®,å¯ä»¥å‘ç°å­è¿‡ç¨‹`sub_1000113D`å¼•ç”¨äº†è¿™ä¸ªå­—ç¬¦ä¸².

æ‰€ä»¥,ä¸ºç ”ç©¶æŒ‚é’©å‡½æ•°çš„è¡Œä¸º,éœ€è¦åˆ†æå­è¿‡ç¨‹`sub_1000113D`,å…¶æµç¨‹å›¾å¦‚ä¸‹

![](../IMG/LAB11-2-9.png)

ä¸Šè¿°çš„å­è¿‡ç¨‹åŠŸèƒ½å¦‚ä¸‹

- ä½¿ç”¨`strstr`å‡½æ•°å¯»æ‰¾é‚®ä»¶æ•°æ®ä¸­çš„`RCPT TO:`å­—ç¬¦ä¸²çš„ä½ç½®,æ‰¾åˆ°å­˜å‚¨æ”¶ä»¶äººæ•°æ®ä¿¡æ¯çš„ä½ç½®
- ä¿®æ”¹é‚®ä»¶ä¸­çš„æ”¶ä»¶äººä¿¡æ¯,æ·»åŠ ä¸€ä¸ªæ”¶ä»¶äºº`billy@malwareanalysisbook.com`(==è¯¦è§é—®é¢˜8åˆ†æ==)
- å°†é‚®ä»¶å‚æ•°ä¼ ç»™`socket`å‡½æ•°

å› æ­¤æŒ‚é’©å‡½æ•°çš„è¡Œä¸ºæ˜¯åœ¨å‘é€é‚®ä»¶æ—¶ä¿®æ”¹æ”¶ä»¶äººä¿¡æ¯,ä½¿æ¶æ„ä»£ç æŒ‡å®šçš„é‚®ç®±æ”¶åˆ°è¢«æ„ŸæŸ“ä¸»æœºå‘é€çš„é‚®ä»¶.

#### é—®é¢˜7 :å®è¡Œæ¶æ„æ”»å‡»çš„è¿›ç¨‹

æ ¹æ®`é—®é¢˜5`çš„åˆ†æ,å­è¿‡ç¨‹`sub_100014B6`ä¼šåˆ¤æ–­å½“å‰è°ƒç”¨è¯¥æ¶æ„`DLL`åº“æ–‡ä»¶çš„è¿›ç¨‹æ˜¯å¦ä¸º`thebat.exe`æˆ–`outlook.exe`æˆ–`msimn.exe`ä»¥å†³å®šç¨‹åºæ˜¯å¦é€€å‡º.ç»è¿‡æŸ¥è¯¢èµ„æ–™,å¯ä»¥çŸ¥é“`thebat`æˆ–`outlook`æˆ–`msimn`éƒ½æ˜¯é€‚ç”¨äº`xp`ç³»ç»Ÿçš„é‚®ä»¶ç¨‹åº.

ç»¼ä¸Š,æ¶æ„ä»£ç åªåœ¨è¢«é‚®ä»¶ç¨‹åº`thebat`æˆ–`outlook`æˆ–`msimn`çš„è¿›ç¨‹ç©ºé—´è£…è½½æ‰æœ‰æ•ˆ.

#### é—®é¢˜8: æŒ‡å®šæ–‡ä»¶çš„åŠŸèƒ½

> æŒ‡å®šæ–‡ä»¶:`Lab11-02.ini`

ä¸ºåˆ†ææ–‡ä»¶`Lab11-02.ini`çš„åŠŸèƒ½,éœ€è¦`DLLMain`å‡½æ•°çš„å­è¿‡ç¨‹`sub_100010B3`.

ä¸ºåˆ†æå­è¿‡ç¨‹`sub_100010B3`,å…ˆå°†`Lab11-02.ini`æ”¾åˆ°`system32`æ–‡ä»¶å¤¹ä¸‹,å†ä½¿ç”¨`Ollydbg`åœ¨`sub_100010B3`è°ƒç”¨ç»“æŸåè®¾ç½®æ–­ç‚¹,å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯

![](../IMG/LAB11-2-5.png)

å¯çŸ¥è¯¥å­è¿‡ç¨‹çš„è¿”å›å€¼æ˜¯é‚®ç®±åœ°å€å­—ç¬¦ä¸²`billy@malwareanalysisbook.com`.

é™æ€åˆ†æè¯¥å­è¿‡ç¨‹,å¯ä»¥å‘ç°è¯¥å­è¿‡ç¨‹æœªè°ƒç”¨ä»»ä½•`Windows`åŠŸèƒ½å‡½æ•°.

ç”±æ­¤,å¯æ¨æµ‹è¯¥å­—ç¬¦ä¸²æ˜¯é€šè¿‡æ–‡ä»¶`Lab11-02.ini`ä¸­ä¹±ç `CHMMXaL@MV@SD@O@MXRHRCNNJBNL`ç»è¿‡æ±‡ç¼–æŒ‡ä»¤è§£å¯†çš„ç»“æœ.

ç»¼ä¸Š,æ–‡ä»¶`Lab11-02.ini`çš„åŠŸèƒ½æ˜¯æä¾›é‚®ç®±åœ°å€å¯†æ–‡.

#### é—®é¢˜9: ä½¿ç”¨æŒ‡å®šå·¥å…·æ•æ‰è¯¥æ¶æ„ä»£ç è¡Œä¸ºçš„æ–¹å¼

> æŒ‡å®šå·¥å…·:`Wireshark`

ä¸ºæŠ“å–æ¶æ„ä»£ç è¡Œä¸º,éœ€è¦æŒ‰ç…§å¦‚ä¸‹çš„æ–¹æ³•å’Œæ­¥éª¤

- å¤åˆ¶æ–‡ä»¶`Lab11-02.ini`åˆ°`system32`æ–‡ä»¶å¤¹
- ä½¿ç”¨æŒ‡ä»¤`rundll32.exe Lab11-02.dll installer`å®‰è£…æ¶æ„ä»£ç 

- æ‰“å¼€`Wireshark 1.4.0`(é€‚ç”¨äº`XP`ç³»ç»Ÿ),ç‚¹å‡»èœå•æ çš„`Capture/Interface`,å¹¶ç‚¹å‡»`start`å¼€å§‹æ•è·æ•°æ®åŒ…
- å¯åŠ¨`Outlook`å®¢æˆ·ç«¯,å‘é€é‚®ä»¶
- ä½¿`Wireshark`åœæ­¢æ•æ‰æ•°æ®åŒ…


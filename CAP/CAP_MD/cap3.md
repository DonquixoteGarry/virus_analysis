## 第三章 基本动态分析

### 基本动态分析定义

- 有时静态分析会难以进行下去,因为
  - 混淆技术
  - 加壳技术
  - 目前可用静态分析技术均无效
- 动态分析展示恶意软件的具体行为

### 沙盒技术

#### 定义

- 一个实现基本动态分析技术的多合一软件
- 提供模仿网络服务的虚拟环境

#### 特点

- 易于使用
- 昂贵
- 输出`PDF`格式报告
- 无命令行选项(影响僵尸网络软件分析)
- 运行时间短,无法触发和记录所有事件
- 可能被反虚拟机技术探测到
- 运行环境是特定的

### `DLL`库文件的启动

#### 基本启动方式

- 原因:`DLL`库文件无法直接运行,需要借助`Rundll32.exe`等程序运行
- `启动格式1`: `Rundll32.exe` `DLL文件名`, `导出参数`
  - `导出参数`:就是库文件的导出函数名,可以使用以下形式
    - 直接使用函数名
    - 使用函数对应的序号
- `启动格式2`:`Rundll32.exe` `rpr32x.dll`,`InstallService` `服务名`
- `启动格式3`:`net` `start` `服务名`
  - `启动格式2`和`启动格式3`等效

#### 其他启动方式

- 通过修改`PE`文件头将`DLL`文件修改为`EXE`文件

### 进程监视器`Process Monitor`

#### 监视方式和注意事项

- 监视对象:所有事件,包括
  - 注册表
  - 文件系统
  - 网络
  - 进程
  - 线程活动
- 监视结果:所有事件记录(可以通过条件筛选感兴趣的对象)
- 注意事项:不要运行过久,防止数据填满内存使得机器崩溃

#### `Process Monitor`的使用

- `Process Monitor`:一款常用系统进程监视软件

- 基本功能
  - 停止/开始捕获事件

  - 删除捕获事件记录

  - 依事件类型(注册表/文件系统/网络/进程)筛选记录

- 筛选方法

  - `exclude`筛选(除外筛选),用于在恶意软件启动前,将正常的活动捕获记录除外
    - 按进程名除外(右键点击进程名选择`exclude`)
    - 按系统调用除外
  - `include`筛选(条件筛选),用于筛选感兴趣的捕获记录,常选择以下筛选项目
    - 进程名(`Process Name`)
    - 操作(`Operation`)
    - 详细(`Detail`)

### 进程浏览器`Process Explorer`

#### 基本定义和功能

- 定义:一款增强型任务管理器软件
- 功能:列出所有目前系统正在运行的进程,包括以下内容
  - 载入的动态链接库
  - 进程的各种属性的值
  - 总系统的信息

#### 进程的不同颜色区分

- 粉色:服务
- 蓝色:进程
- 绿色:新进程
- 红色:已终止进程

#### 底部窗格显示模式

- `DLL`模式:展示所有库文件信息
- `Handle(句柄)`模式:展示所有进程句柄

#### 进程主要属性值

- `DEP`状态值:数据执行保护开启状态
- `ASLR`状态值:地址空间配置随机化是否开启
- 磁盘文件与内存文件中的字符串集
  - 经过比对可确认是否发生了进程替换

### 注册表工具`Regshot`

#### 定义

- 一款开源注册表比较工具

#### 功能

- 产生注册表快照
- 比较两注册表快照差异

### 网络伪造技术

#### 常见伪造技术

- `beacon`恶意软件可以在感染主机后,定时与`C&C`服务器(命令与控制服务器)通信
- 网络伪造可以隐藏接收到的通信指令信号等信息
- 网络伪造绕过虚拟机和因特网之间的物理隔离

#### 常见网络工具及其功能

- `ApateDNS`:可用于`DNS`解析的重定向
- `Nmap`:它的`Ncat`指令可用于监听网络
- `Wireshark`:一款网络嗅探工具,可以用以了解恶意软件的网络通信情况(细见`cap14.md`),具体功能有
  - 捕获数据包,拦截和记录网络流量
  - 可以跟踪自本机发出的和外部发出的`TCP`流
  - 可以以文件形式保存自本机发出的和外部发出的`TCP`流的信息
- `inetsim`:一款网络服务模拟工具,可以模拟网络服务,可以实现以下效果
  - 欺骗浏览器
  - 欺骗`Nmap`软件的探测
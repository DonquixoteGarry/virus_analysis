## 第一章 基本静态分析技术

### 静态分析概述

- 通过对二进制可执行代码或结构的逆向工程来了解其功能
- 所谓静态,就是在程序未运行时分析



### 基本静态分析

- 不使用反汇编手段
- 为动态分析和高级分析提供好的指引(指标)
- 使用大量工具
- 基本静态分析技术

  - 反病毒扫描
  - 哈希值
  - 文件字符串、函数和文件头

### 反病毒扫描技术

- 对已知恶意软件 
   - 扫描文件特征码
   - 启发式扫描技术,统计地、静态地分析指令序列,得到概率性的规律
- 对未知恶意软件
   - 代码混淆
   - 使用语法混淆的多态病毒
   - 使用语义混淆的变形病毒



### 哈希技术

- 用来唯一标识恶意软件的方法

- `MD5`:信息摘要算法,128比特位哈希

- `SHA-1`:安全哈希算法,160比特位哈希 

#### 哈希过程

- 输入:任意大小的一个文件或任意长度的字符串
- 输出:固定长度哈希值
- 结果:在实践中有效地唯一地标识一个文件,因为`MD5`哈希值碰撞的几率极低

#### 哈希的用途

- 标识一个恶意软件
- 通过分享哈希值来帮其他人标识恶意软件
- 在线搜索哈希值以与他人已经发现的恶意软件哈希值相比对



### 寻找字符串

#### 字符串定义

- 可打印字符序列
- 可用`ASCII`和`UNICODE`等编码方式以二进制字符重现字符串
  - `ASCII`:美国信息交换标准代码,8个比特位
  - `UNICODE`:万国码,16个比特位,包含大量特殊字符

#### `Strings`指令

- 可在二进制可执行文件中查找长度大于等于3的`ASCII`和`UNICODE`字符串
- 在终端中使用并在终端输出结果



### 恶意软件的加壳和混淆技术

- 目标:是恶意软件难以逆向工程和侦察分析
- 加壳:压缩二进制文件大小(是混淆的一种)
- 混淆:隐藏执行信息

#### 加壳和混淆的效果

- 加壳和混淆前的合法软件:可得大量字符串
- 加壳和混淆后的恶意软件:得到少量字符串

#### 文件加壳

- 代码被压缩,如常见压缩软件一样
- 使字符串和指令不可见、不可得
- 只能看见未加壳的`wrapper`段数据
  - `wrapper`段:该段数据是已加壳软件中的直接可用数据,用以在运行时解压其他部分数据,数据量较小

#### 相关软件

- `UPX`:全名`Ultimate Packer for eXecutables`,加壳软件
- `PEiD`:加壳软件分析工具
  - 许多`PEiD`插件可能无警告运行恶意程序
  - `PEiD`易受攻击(如0.92版本中缓冲区溢出漏洞可被攻击,用以执行任意代码)
  - 注意使用最新版本
- `String`:如上述,可用于分析加壳软件



### `PE`文件格式

#### `PE`文件

- `Portable Executable File Format`:可移植可执行文件格式
- 是`windows`系统的`exe`可执行文件和`dll`动态链接库文件使用的格式
- 包含`windows`系统用于装载二进制可执行文件的必要信息
- 是`windows`系统绝大多数文件的执行格式

#### `PE`文件头组成

- 代码数据信息
- 应用程序类型
- 所需库函数
- 空间需求

#### 相关软件

- `LordPE`:用于分析`PE`格式文件



### 链接库和函数

- 库文件可存储程序所需函数
- 通过链接,库文件与主可执行程序相连接
- 三种链接方式
  - 静态链接
  - 运行时链接
  - 动态链接

#### 静态链接

- `windows`系统可执行程序中较少使用,常用于`UNIX`和`Linux`系统
- 所需库文件中的所有代码被复制到`exe`可执行文件中
- 文件大小较大
- 所需内存(存储)空间大

#### 动态链接

- 更常见的使用链接方式
- 主机操作系统在程序装载时搜索所需库文件

#### 运行时链接

- 在友好的程序中不受欢迎
- 常见于恶意软件,尤其是加壳混淆后的恶意软件
- 不在程序启动时装载库文件,只在必要时装载
- 常使用`LoadLibrary`函数和`GetProcAddress`函数实现

#### 库文件的其他要点

- `PE`文件头会列出将被装载的库文件与函数
- 使用库文件会隐藏当前程序的具体行为
- 调用`URLDownloadToFile`函数表明该程序联网下载数据

#### 相关程序

- `Dependency Walker`:依赖关系遍历程序,该程序可列出指定可执行程序的所有依赖库文件与库文件相关信息

#### 动态链接函数使用情况

- 常用软件:使用动态链接库较多
- 恶意软件:使用动态链接库较少

#### 常见动态链接库文件

- `Kernel32.dll`:包含操作内存、文件和硬件等核心功能依赖项的库文件
- `Advapi32.dll`:包含服务管理和注册表等高级功能依赖项的库文件
- `User32.dll`:包含如按钮、滚动条等用户接口的控制与反应的依赖项的库文件
- `Gdi32.dll`:包含图形化和显示控制的依赖项的库文件
- `Ntdll.dll`:包含对内核的接口,不被一般可执行文件直接导入,常被`Kernel32.dll`间接导入,若被可执行程序直接导入,表明程序编写者在调用普通程序通常不直接调用的功能(如控制进程等),普通程序通常使用接口间接调用他们
- `WSock32.dll`&`Ws2_32.dll`:包含网络功能实现的依赖项的库文件
- `Wininet.dll`:包含高层次网络功能(如`FTP`、`HTTP`、`NTP`等网络协议)的依赖项的库文件

#### `exe`可执行文件与`dll`库文件的关系

- 库文件的导出函数
- 可执行文件导入函数
- 所有的导入导出关系都列在`PE`文件头中



### `PE`文件头和节

#### 主要的`PE`文件节内容

- `.text节`:`CPU`用以执行的指令
- `.rdata节`:导入导出文件依赖关系
- `.data节`:全局数据
- `.rsrc节`:字符串、图标、图像、菜单等数据

#### 其他部分

- 时间戳:该可执行程序编译的时间
  - 旧程序更易被反病毒软件所知
  - 时间日期可被伪造
- `IMAGE_SECTION_HEADER`
  - 虚拟大小:程序载入后内存的大小
  - 原始数据大小:程序在磁盘中的大小
    - 普通程序两者基本相近
    - 加壳的可执行文件虚拟大小明显小于原始数据大小

#### 相关程序

- `PEView`:用于分析`PE`文件结构
- `Resource Hacker`:用于分析`.rsrc节`的数据,检查字符串、图标、菜单等资源调用情况